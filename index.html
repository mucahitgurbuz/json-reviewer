<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .start-view {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      .start-view h1 {
        color: #ff7535;
      }
      .start-view p {
        max-width: 300px;
        margin: 10px auto;
      }
      .start-view button {
        background-color: #ff7535;
        border: none;
        color: white;
        padding: 10px 20px;
        margin-top: 10px;
        cursor: pointer;
      }
      .contents-wrapper {
        display: none;
        padding-bottom: 70px;
      }
      .table-header {
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 10;
      }
      .approved,
      .rejected,
      .pending {
        transition: background-color 0.3s;
      }
      .approved {
        background-color: #e0ffe0;
      }
      .rejected {
        background-color: #ffcccc;
      }
      .pending {
        background-color: #ffffcc;
      }
      .bottom-sticky {
        position: fixed;
        bottom: 0;
        background-color: white;
        padding: 10px;
        display: none;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 70px;
      }
      .bottom-sticky p {
        flex-grow: 1;
        margin: 0 20px;
        font-size: 0.9em;
        color: #ff7535;
      }
      #counter {
        flex-shrink: 0;
        font-weight: bold;
        font-size: larger;
      }
      .note-box {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        outline: none;
        resize: none;
      }
      .button-wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .notes-indicator {
        color: #ff7535;
      }
    </style>
    <title>Explainer Review Tool</title>
  </head>
  <body>
    <div class="start-view">
      <h1>Explainer Review Tool</h1>
      <p>Start by importing the JSON file</p>
      <button id="importBtn">Import</button>
      <input type="file" id="jsonFileInput" style="display: none" />
    </div>
    <div class="contents-wrapper">
      <table class="table">
        <thead>
          <tr class="table-header">
            <th>#</th>
            <th>Trainer</th>
            <th>L1/L2</th>
            <th>LessonUuid/ItemId</th>
            <th>Item</th>
            <th>AI Content</th>
            <th style="min-width: 150px">Status</th>
          </tr>
        </thead>
        <tbody id="itemsTable"></tbody>
      </table>
    </div>
    <div class="bottom-sticky">
      <p id="counter"></p>
      <p>
        This session is not backed up, If you close or refresh the page all
        changes you made will be gone. It is advised to export and use the
        exported file to continue.
      </p>
      <button id="exportBtn" class="btn btn-primary">Export</button>
    </div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="notesModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="notesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notesModalLabel">Notes</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="noteBox" class="note-box"></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveNotes()"
              data-dismiss="modal"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("jsonFileInput");
      const importBtn = document.getElementById("importBtn");
      const itemsTable = document.getElementById("itemsTable");
      const counter = document.getElementById("counter");
      let currentNoteIndex = -1;

      importBtn.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = (event) => {
          const content = event.target.result;
          const data = JSON.parse(content);
          populateItemsTable(data);
          $(".start-view").hide();
          $(".contents-wrapper").show();
          $(".bottom-sticky").css("display", "flex");
        };

        reader.readAsText(file);
      });

      function populateItemsTable(data) {
        let pendingCount = 0;
        for (let i = 0; i < data.length; i++) {
          const item = data[i];

          if (!item.status) item.status = "Pending";

          const row = document.createElement("tr");
          row.innerHTML = `
<td>${item.index}</td>
            <td>${item.trainerType}/${item.interaction}</td>
            <td>${item.locale} / ${item.learnLanguageAlpha3}</td>
            <td>${item.lessonUuid} / ${item.itemId}</td>
            <td>${item.learnLanguageItem}</td>
            <td>
              ${
                item.contents.meaning.length > 1
                  ? `<ul>
                    ${item.contents.meaning
                      .map((meaning) => `<li>${meaning}</li>`)
                      .join("")}
                  </ul>`
                  : `<p>${item.contents.meaning[0]}</p>`
              }
              <hr>
                ${
                  item.contents.grammar.length > 1
                    ? `<ul>
                    ${item.contents.grammar
                      .map((grammar) => `<li>${grammar}</li>`)
                      .join("")}
                  </ul>`
                    : `<p>${item.contents.grammar[0]}</p>`
                }
              <hr>
                ${
                  item.contents.examples.length > 1
                    ? `<ul>
                    ${item.contents.examples
                      .map((example) => `<li>${example}</li>`)
                      .join("")}
                  </ul>`
                    : `<p>${item.contents.examples[0]}</p>`
                }
              <hr>
                ${
                  item.contents.goodToKnow.length > 1
                    ? `<ul>
                    ${item.contents.goodToKnow
                      .map((goodToKnow) => `<li>${goodToKnow}</li>`)
                      .join("")}
                  </ul>`
                    : `<p>${item.contents.goodToKnow[0]}</p>`
                }
            </td>
            <td>
              <div class="button-wrapper">
              <select class="form-control" onchange="updateItemStatus(this, ${i})">
                <option ${
                  item.status == "Pending" ? "selected" : ""
                }>Pending</option>
                <option ${
                  item.status == "Approved" ? "selected" : ""
                }>Approved</option>
                <option ${
                  item.status == "Rejected" ? "selected" : ""
                }>Rejected</option>
              </select>
              <button type="button" class="btn btn-secondary" onclick="openNotesModal(${i})">
                ${item.notes ? "Edit" : "Add"} Notes
              </button>
              <p class="notes-indicator">${
                item.notes ? "There is a reviewer note!" : ""
              }</p>
              </div>
            </td>
          `;
          row.classList.add(item.status.toLowerCase());
          itemsTable.appendChild(row);

          if (item.status == "Pending") {
            pendingCount++;
          }
        }
        window.reviewItemsData = data;
        counter.innerText = `Items Left: ${pendingCount} / ${data.length}`;
      }

      window.updateItemStatus = (el, index) => {
        const status = el.value;
        window.reviewItemsData[index].status = status;
        const row = itemsTable.children[index];
        row.className = "";
        row.classList.add(status.toLowerCase());

        let pendingCount = 0;
        for (let i = 0; i < window.reviewItemsData.length; i++) {
          if (window.reviewItemsData[i].status == "Pending") {
            pendingCount++;
          }
        }
        counter.innerText = `Items Left: ${pendingCount} / ${window.reviewItemsData.length}`;
      };

      window.openNotesModal = (index) => {
        $("#notesModal").modal("show");
        const noteBox = document.getElementById("noteBox");
        noteBox.value = window.reviewItemsData[index].notes || "";
        currentNoteIndex = index;
      };

      window.saveNotes = () => {
        const noteBox = document.getElementById("noteBox");
        window.reviewItemsData[currentNoteIndex].notes = noteBox.value;
        const row = itemsTable.children[currentNoteIndex];
        const notesButton = row.querySelector("button");
        const notesIndicator = row.querySelector("p");
        notesButton.textContent = noteBox.value ? "Edit Notes" : "Add Notes";
        notesIndicator.textContent = noteBox.value
          ? "There is a reviewer note!"
          : "";
        currentNoteIndex = -1;
      };

      document.getElementById("exportBtn").onclick = () => {
        const jsonStr = JSON.stringify(window.reviewItemsData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "reviewed_items.json";
        document.body.appendChild(link);

        link.click();

        document.body.removeChild(link);
      };
    </script>
  </body>
</html>
