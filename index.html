<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .start-view {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      .start-view h1 {
        color: #ff7535;
      }
      .start-view p {
        max-width: 300px;
        margin: 10px auto;
      }
      .start-view button {
        background-color: #ff7535;
        border: none;
        color: white;
        padding: 10px 20px;
        margin-top: 10px;
        cursor: pointer;
      }
      .contents-wrapper {
        display: none;
      }
      .table-header {
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 10;
      }
      .approved,
      .rejected,
      .pending {
        transition: background-color 0.3s;
      }
      .approved {
        background-color: #e0ffe0;
      }
      .rejected {
        background-color: #ffcccc;
      }
      .pending {
        background-color: #ffffcc;
      }
      .bottom-sticky {
        position: fixed;
        bottom: 0;
        background-color: white;
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        width: 100%;
        height: 70px;
      }
      .bottom-sticky p {
        flex-grow: 1;
        margin: 0 20px;
        font-size: 0.9em;
        color: #ff7535;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <title>Explainer Review Tool</title>
  </head>
  <body>
    <div class="start-view">
      <h1>Explainer Review Tool</h1>
      <p>Start by importing the JSON file</p>
      <button id="importBtn">Import</button>
      <input type="file" id="jsonFileInput" style="display: none" />
    </div>
    <div class="contents-wrapper">
      <table class="table">
        <thead>
          <tr class="table-header">
            <th>L2</th>
            <th>L1</th>
            <th>LessonUuid</th>
            <th>ItemId</th>
            <th>Contents</th>
            <th style="min-width: 150px">Status</th>
          </tr>
        </thead>
        <tbody id="itemsTable"></tbody>
      </table>
    </div>
    <div class="bottom-sticky">
      <p>
        This session is not backed up, If you close or refresh the page all
        changes you made will be gone. It is advised to export and use the
        exported file to continue.
      </p>
      <button id="exportBtn" class="btn btn-primary">Export JSON</button>
    </div>
    <script>
      const fileInput = document.getElementById("jsonFileInput");
      const importBtn = document.getElementById("importBtn");
      const itemsTable = document.getElementById("itemsTable");

      importBtn.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();

        reader.onload = (event) => {
          const content = event.target.result;
          const data = JSON.parse(content);
          populateItemsTable(data);
          $(".start-view").hide();
          $(".contents-wrapper").show();
        };

        reader.readAsText(file);
      });

      function populateItemsTable(data) {
        for (let i = 0; i < data.length; i++) {
          const item = data[i];

          if (!item.status) item.status = "Pending";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.learnLanguageAlpha3}</td>
            <td>${item.locale}</td>
            <td>${item.lessonUuid}</td>
            <td>${item.itemId}</td>
            <td>${item.contents.join("<br>")}</td>
            <td>
              <select class="form-control" onchange="updateItemStatus(this, ${i})">
                <option ${
                  item.status == "Pending" ? "selected" : ""
                }>Pending</option>
                <option ${
                  item.status == "Approved" ? "selected" : ""
                }>Approved</option>
                <option ${
                  item.status == "Rejected" ? "selected" : ""
                }>Rejected</option>
              </select>
            </td>
          `;
          row.classList.add(item.status.toLowerCase());
          itemsTable.appendChild(row);
        }
        window.reviewItemsData = data;
      }

      window.updateItemStatus = (el, index) => {
        const status = el.value;
        window.reviewItemsData[index].status = status;
        const row = itemsTable.children[index];
        row.className = "";
        row.classList.add(status.toLowerCase());
      };

      document.getElementById("exportBtn").onclick = () => {
        const jsonStr = JSON.stringify(window.reviewItemsData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "reviewed_items.json";
        document.body.appendChild(link);

        link.click();

        document.body.removeChild(link);
      };
    </script>
  </body>
</html>
